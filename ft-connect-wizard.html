<!--
Copyright 2017 FileThis, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->


<link rel="import" href="../ft-confirmation-dialog/ft-confirmation-dialog.html">
<link rel="import" href="../ft-connect-behavior/ft-connect-behavior.html">
<link rel="import" href="../ft-connection-panel/ft-connection-panel.html">
<link rel="import" href="../ft-document-panel/ft-document-panel.html">
<link rel="import" href="../ft-labeled-icon-button/ft-labeled-icon-button.html">
<link rel="import" href="../ft-source-panel/ft-source-panel.html">
<link rel="import" href="../ft-user-interaction-form/ft-user-interaction-form.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../polymer/polymer.html">

<!--
`<ft-connect-wizard>`

An element that implements a FileThis user workflow as a set of tabbed panels. As the user progresses, they navigate to the next tab in the sequence.

@demo
-->
<dom-module id="ft-connect-wizard">

    <template>

        <style include="iron-flex iron-flex-alignment iron-positioning"></style>

        <style>
            :host {
                display:block;
                @apply --layout-vertical;
                @apply --ft-connect-wizard;
            }
        </style>

        <style>

            .slidein {
                animation-duration: 1s;
                animation-name: slidein;
            }

            @keyframes slidein {
                from {
                    margin-left:100%;
                }

                to {
                    margin-left:0;
                }
            }

            @keyframes slideout {
                from {
                    margin-left:0;
                }

                to {
                    margin-left:100%;
                }
            }

        </style>

        <!-- Header -->
        <div class="layout horizontal center">

            <div class="flex">
                [[_instructions]]
            </div>

            <paper-icon-button
                    on-tap="_onBackButtonTapped"
                    icon="arrow-back"
                    alt="back"
                    title="back">
            </paper-icon-button>
            <paper-icon-button
                    on-tap="_onNextButtonTapped"
                    icon="arrow-forward"
                    alt="next"
                    title="next">
            </paper-icon-button>

        </div>

        <!-- Panels -->
        <iron-pages
                id="panels"
                class="flex layout vertical"
                style="border-top:1px solid #DDD; "
                attr-for-selected="name"
                selected="{{_selectedPanelName}}">

            <!-- Source panel -->
            <ft-source-panel
                    id="sourcesPanel"
                    name="sources"
                    class="flex"
                    show-title="false"
                    selected-filter-id="{{selectedFilterId}}"
                    code="{{_sourcesCode}}"
                    sources="[[sources]]">
            </ft-source-panel>

            <!-- Connection panel -->
            <ft-connection-panel
                    id="connectionsPanel"
                    name="connections"
                    class="flex"
                    show-title="false"
                    connections="[[connections]]"
                    code="{{_connectionsCode}}"
                    sources="[[sources]]">
            </ft-connection-panel>

            <!-- Document panel -->
            <ft-document-panel
                    id="documentsPanel"
                    name="documents"
                    class="flex"
                    show-title="false"
                    show-grid-button="true"
                    show-list-button="true"
                    show-preview-button="false"
                    show-upload-button="false"
                    show-download-button="false"
                    show-delete-button="true"
                    show-document-count="false"
                    code="{{_documentsCode}}"
                    documents="[[documents]]">
            </ft-document-panel>

        </iron-pages>

        <!-- User interaction dialog -->
        <paper-dialog modal id="modalInteractionDialog"
                      style="width:450px;
                      padding-left:40px; padding-top:12px; padding-right:40px; padding-bottom:5px;">

            <ft-user-interaction-form
                    id="interactionForm"
                    version="[[interactionVersion]]"
                    request="[[_interactionRequest]]"
                    response="{{_interactionResponse}}"
                    on-submit-response="_onSubmitInteractionResponse"
                    on-button-clicked="_onInteractionFormButtonClicked"
                    style="background:white; border:1px solid #DDD;">
            </ft-user-interaction-form>

        </paper-dialog>

        <!-- Uploader -->
        <input
                id="uploader"
                hidden
                type="file"
                on-change="_onUploaderFilesChanged"
                multiple="true"
                accept="[[_uploadableFileTypes]]">

        <!-- Downloader -->
        <a
                id="downloader"
                hidden
                href$="[[_downloadUrl]]"
                download$="[[_downloadFilename]]">
        </a>

        <!-- Confirmation dialog -->
        <ft-confirmation-dialog id="confirmationDialog"></ft-confirmation-dialog>

    </template>

    <script>
        Polymer({

            is: 'ft-connect-wizard',

            behaviors: [
                FileThis.ConnectBehavior,
                FileThis.ErrorBehavior, FileThis.HttpBehavior // TODO: Why do we have to include these when ConnectBehavior aready does?
            ],

            listeners:
            {
                'commit': '_onCommitLocal'
            },

            properties: {

                /** Name of the selected panel. One of: "sources", "connections", or "documents". */
                _selectedPanelName:
                {
                    type: String,
                    value: "sources",
                    observer: "_onSelectedPanelNameChanged"
                },

                _instructions:
                {
                    type: String,
                    notify: true,
                    value: "Instructions"
                }
            },

            ready: function()
            {
                this.async(function()
                {
                    this._selectedPanelName = "sources";
                });

                this.codeTemplatePath = "../bower_components/ft-connect-wizard/data/code-template.html";
            },

            _onSelectedPanelNameChanged: function(to, from)
            {
                this._instructions = this._getInstructions();

//                var panels = this.$.panels.children;
//                var toPanel = panels[to];
//                var fromPanel = panels[from];
//
//                if (!toPanel.classList.contains('slidein'))
//                    toPanel.classList.add("slidein");
//
//                if (fromPanel !== undefined)
//                    fromPanel.classList.remove("slidein");
            },

            _getInstructions: function()
            {
                switch (this._selectedPanelName)
                {
                    case "sources":
                        return this._getInstructionsForSourcePanel();
                    case "connections":
                        return this._getInstructionsForConnectionPanel();
                    case "documents":
                        return this._getInstructionsForDocumentPanel();
                    default:
                        return "";
                }
            },

            _getInstructionsForSourcePanel: function()
            {
                return "Click on a source to connect to it.";
            },

            _getInstructionsForConnectionPanel: function()
            {
                return "Observe that you have connections.";
            },

            _getInstructionsForDocumentPanel: function()
            {
                return "Observe that you have documents.";
            },


            // User action event handling --------------------------------------------------------------------------

            _onInteractionFormButtonClicked: function(event)
            {
                var detail = event.detail;
                if (detail.action === "defer")
                    this.$.modalInteractionDialog.close();
            },

            _onSubmitInteractionResponse: function(event)
            {
                var interactionRequest = this._interactionRequest;
                var interactionResponse = this._interactionResponse;

                var connectionId = interactionRequest.connectionId;
                var interactionId = interactionRequest.id;
                var url = this.server + this.apiPath +
                    "/accounts/" + this.account.id +
                    "/connections/" + connectionId +
                    "/interactions/" + interactionId +
                    "/response";
                var options = this._buildHttpOptions();

                return this.httpPut(url, interactionResponse, options)
                    .then(function()
                    {
                        this.$.modalInteractionDialog.close();
                    }.bind(this))
                    .catch(function(reason)
                    {
                        this._handleError(reason);
                        this.$.modalInteractionDialog.close();
                    }.bind(this));
            },

            _onBackButtonTapped: function(event)
            {
                var previousPanelName = this._getPreviousPanelName();
                if (!previousPanelName)
                    return;
                this._selectedPanelName = previousPanelName;
            },

            _onNextButtonTapped: function(event)
            {
                var nextPanelName = this._getNextPanelName();
                if (!nextPanelName)
                    return;
                this._selectedPanelName = nextPanelName
            },

            _getNextPanelName: function()
            {
                switch (this._selectedPanelName)
                {
                    case "sources":
                        return "connections";
                    case "connections":
                        return "documents";
                    case "documents":
                        return null;
                    default:
                        return null;
                }
            },

            _getPreviousPanelName: function()
            {
                switch (this._selectedPanelName)
                {
                    case "sources":
                        return null;
                    case "connections":
                        return "sources";
                    case "documents":
                        return "connections";
                    default:
                        return null;
                }
            },

//            _onSubmitInteractionResponseNew: function(event)
//            {
//                var interactionRequest = this._interactionRequest;
//                var interactionResponse = this._interactionResponse;
//
//                var connectionId = interactionRequest.connectionId;
//                var interactionId = interactionRequest.id;
//                var url = this.server + this.apiPath +
//                    "/accounts/" + this.account.id +
//                    "/connections/" + connectionId +
//                    "/interactions/" + interactionId +
//                    "/response";
//            var options = this._buildHttpOptions();
//
//                return this.httpPost(url, interactionResponse, options)
//                    .then(function()
//                    {
//                        this.$.modalInteractionDialog.close();
//                    }.bind(this))
//                    .catch(function(reason)
//                    {
//                        this._handleError(reason);
//                        this.$.modalInteractionDialog.close();
//                    }.bind(this));
//            },

            poseNextPendingInteractionRequest: function()
            {
                if (this._interactionRequests.length === 0)
                    return;

                // If we already have a dialog posed
                if (this.$.modalInteractionDialog.opened)
                    return;

                // Pose the first request
                var interactionRequest = this._interactionRequests[0];
                this._interactionRequest = interactionRequest;
                this.$.modalInteractionDialog.open();
                return interactionRequest;
            },

            _poseNextPendingInteractionRequest: function()
            {
                if (!this.poseUserInteractionsAutomatically)
                    return;
                return this.poseNextPendingInteractionRequest();
            },

            _onCommitLocal: function(event)
            {
                var origin = event.path[0];
                if (origin.id === "createConnectionDialog")
                    this._selectedPanelName = "connections";  // TODO: Make this a configurable option?
            }

        });
    </script>
</dom-module>

